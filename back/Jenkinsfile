pipeline {
    agent any
    
    environment {
        // ì„œë²„ ì •ë³´
        SERVER_URL = 'http://16.176.15.30'
        DOCKER_REGISTRY = '16.176.15.30:5000'  // Docker Registryê°€ ìˆë‹¤ë©´
        IMAGE_NAME = 'sca-backend'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´
        DB_HOST = 'mysql'
        DB_NAME = 'sca_db'
        DB_USER = 'root'
        DB_PASSWORD = credentials('mysql-root-password') ?: '1234'
        
        // ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ë³€ìˆ˜
        JWT_SECRET = credentials('jwt-secret') ?: 'your-secret-key-must-be-at-least-256-bits-long-for-HS256-algorithm-security'
        JWT_EXPIRATION = '900000'
        JWT_REFRESH_EXPIRATION = '604800000'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¦ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ...'
                checkout scm
                sh 'git log -1 --pretty=format:"%h - %an, %ar : %s"'
            }
        }
        
        stage('Build') {
            steps {
                echo 'ğŸ”¨ Gradle ë¹Œë“œ ì‹œì‘...'
                sh '''
                    chmod +x ./gradlew
                    ./gradlew clean build -x test
                '''
            }
            post {
                success {
                    echo 'âœ… ë¹Œë“œ ì„±ê³µ!'
                    archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
                }
                failure {
                    echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨!'
                }
            }
        }
        
        stage('Test') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
                echo 'ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰...'
                sh './gradlew test'
            }
            post {
                always {
                    junit 'build/test-results/test/*.xml'
                }
            }
        }
        
        stage('Copy JAR') {
            steps {
                echo 'ğŸ“‹ JAR íŒŒì¼ ì¤€ë¹„...'
                sh '''
                    cp build/libs/*.jar app.jar
                '''
            }
        }
        
        stage('Docker Build') {
            steps {
                echo 'ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ...'
                script {
                    def image = docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
                    def latestImage = docker.build("${IMAGE_NAME}:latest")
                    
                    // ì´ë¯¸ì§€ íƒœê·¸ ì €ì¥
                    env.DOCKER_IMAGE = "${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }
        
        stage('Docker Push') {
            when {
                expression { params.PUSH_TO_REGISTRY == true }
            }
            steps {
                echo 'ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ...'
                script {
                    docker.withRegistry("http://${DOCKER_REGISTRY}") {
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()
                        docker.image("${IMAGE_NAME}:latest").push()
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'ğŸš€ ë°°í¬ ì‹œì‘...'
                script {
                    // Docker Composeë¡œ ë°°í¬
                    // ì™¸ë¶€ MySQL ì‚¬ìš© ì‹œ: docker-compose.server.yml ì‚¬ìš©
                    sh '''
                        COMPOSE_FILE="${COMPOSE_FILE:-docker-compose.server.yml}"
                        docker compose -f ${COMPOSE_FILE} down || true
                        docker compose -f ${COMPOSE_FILE} up -d --build
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ğŸ¥ Health Check...'
                script {
                    def maxAttempts = 30
                    def waitTime = 10
                    def attempt = 0
                    def healthy = false
                    
                    while (attempt < maxAttempts && !healthy) {
                        sleep(waitTime)
                        attempt++
                        
                        try {
                            def response = sh(
                                script: "curl -s -o /dev/null -w '%{http_code}' ${SERVER_URL}:8080/actuator/health",
                                returnStdout: true
                            ).trim()
                            
                            if (response == '200') {
                                healthy = true
                                echo "âœ… Health Check ì„±ê³µ! (ì‹œë„ ${attempt}/${maxAttempts})"
                            } else {
                                echo "â³ Health Check ëŒ€ê¸° ì¤‘... (ì‹œë„ ${attempt}/${maxAttempts}, ì‘ë‹µ: ${response})"
                            }
                        } catch (Exception e) {
                            echo "â³ ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘... (ì‹œë„ ${attempt}/${maxAttempts})"
                        }
                    }
                    
                    if (!healthy) {
                        error("âŒ Health Check ì‹¤íŒ¨! ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                }
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo 'ğŸ’¨ Smoke Test ì‹¤í–‰...'
                script {
                    // ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
                    def healthCheck = sh(
                        script: "curl -s ${SERVER_URL}:8080/actuator/health",
                        returnStdout: true
                    ).trim()
                    
                    echo "Health Check ì‘ë‹µ: ${healthCheck}"
                    
                    if (!healthCheck.contains('UP')) {
                        error("âŒ Smoke Test ì‹¤íŒ¨! Health Checkê°€ UP ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.")
                    }
                    
                    echo 'âœ… Smoke Test í†µê³¼!'
                }
            }
        }
    }
    
    post {
        success {
            echo 'ğŸ‰ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!'
            script {
                // ì„±ê³µ ì•Œë¦¼ (Slack, Email ë“±)
                // slackSend(
                //     channel: '#deployment',
                //     color: 'good',
                //     message: "âœ… SCA-BE ë°°í¬ ì„±ê³µ!\në¹Œë“œ ë²ˆí˜¸: ${env.BUILD_NUMBER}\nì„œë²„: ${SERVER_URL}"
                // )
            }
        }
        failure {
            echo 'âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!'
            script {
                // ì‹¤íŒ¨ ì•Œë¦¼
                // slackSend(
                //     channel: '#deployment',
                //     color: 'danger',
                //     message: "âŒ SCA-BE ë°°í¬ ì‹¤íŒ¨!\në¹Œë“œ ë²ˆí˜¸: ${env.BUILD_NUMBER}\në¡œê·¸ í™•ì¸ í•„ìš”"
                // )
            }
        }
        always {
            echo 'ğŸ§¹ ì •ë¦¬ ì‘ì—…...'
            // ì •ë¦¬ ì‘ì—… (ì˜µì…˜)
            // cleanWs()
        }
    }
}

